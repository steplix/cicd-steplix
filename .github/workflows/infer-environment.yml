name: >
  Get environment from tag
  - 'v1.0.1-testing'  -> testing
  - 'v1.0.1-staging'  -> staging
  - 'v1.0.1'          -> production

on:
  workflow_call:
    inputs:
      RELEASE_TAG:
        required: true
        type: string
    outputs:
      ENVIRONMENT:
        description: 'Environment inferred from version tag'
        value: ${{ jobs.infer-environment.outputs.ENVIRONMENT }}

jobs:
  infer-environment:
    runs-on: ubuntu-22.04
    outputs:
      ENVIRONMENT: ${{ steps.set-environment.outputs.ENVIRONMENT }}
    steps:
      - name: Infer environment from RELEASE_TAG
        id: set-environment
        run: |
          if [[ "${{ inputs.RELEASE_TAG }}" =~ ^v?[0-9]{1,10}\.[0-9]{1,10}\.[0-9]{1,10}\-testing(\.[0-9]{1,10})?$ ]]; then
            echo "ENVIRONMENT=testing" >> "$GITHUB_OUTPUT"
          elif [[ "${{ inputs.RELEASE_TAG }}" =~ ^v?[0-9]{1,10}\.[0-9]{1,10}\.[0-9]{1,10}\-staging(\.[0-9]{1,10})?$ ]]; then
            echo "ENVIRONMENT=staging" >> "$GITHUB_OUTPUT"
          elif [[ "${{ inputs.RELEASE_TAG }}" =~ ^v?[0-9]{1,10}\.[0-9]{1,10}\.[0-9]{1,10}$ ]]; then
            echo "ENVIRONMENT=production" >> "$GITHUB_OUTPUT"
          else
            echo "Error: El release ${{ inputs.RELEASE_TAG }} no es vÃ¡lido. Debe ser 'vX.X.X-testing', 'vX.X.X-staging' o 'vX.X.X'." >&2
            exit 1
          fi
      - name: Log inferred environment '${{ steps.set-environment.outputs.ENVIRONMENT }}'
        run: |
          echo "Inferred Environment: ${{ steps.set-environment.outputs.ENVIRONMENT }}"
